{% extends "base.html" %}

{% block title %}Chat with AI Coach - LakshyaAI{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
<style>
    .chat-container {
        display: flex;
        height: calc(100vh - 120px);
        background: #f8fafc;
    }

    .chat-sidebar {
        width: 300px;
        background: white;
        border-right: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
    }

    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
    }

    .chat-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        background: white;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: #f8fafc;
    }

    .chat-input {
        padding: 1rem;
        border-top: 1px solid #e2e8f0;
        background: white;
    }

    .sidebar-header {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .conversation-list {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
    }

    .conversation-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .conversation-item:hover {
        background: #f1f5f9;
    }

    .conversation-item.active {
        background: #dbeafe;
        border-left: 3px solid #3b82f6;
    }

    .message {
        margin-bottom: 1rem;
        animation: fadeIn 0.3s ease-in;
    }

    .message-content {
        max-width: 80%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        position: relative;
    }

    .user-message .message-content {
        background: #3b82f6;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 0.25rem;
    }

    .ai-message .message-content {
        background: white;
        color: #1f2937;
        border: 1px solid #e2e8f0;
        border-bottom-left-radius: 0.25rem;
    }

    .message-time {
        font-size: 0.75rem;
        color: #6b7280;
        text-align: right;
        margin-top: 0.25rem;
    }

    .input-container {
        display: flex;
        gap: 0.5rem;
        align-items: flex-end;
    }

    .message-input {
        flex: 1;
        min-height: 44px;
        max-height: 120px;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.75rem;
        resize: none;
        font-family: inherit;
    }

    .send-button {
        padding: 0.75rem;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .send-button:hover:not(:disabled) {
        background: #2563eb;
    }

    .send-button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (max-width: 768px) {
        .chat-container {
            flex-direction: column;
            height: calc(100vh - 80px);
        }

        .chat-sidebar {
            width: 100%;
            height: 200px;
        }

        .message-content {
            max-width: 90%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Sidebar -->
    <div class="chat-sidebar">
        <div class="sidebar-header">
            <h3 class="text-lg font-semibold text-gray-900">Conversations</h3>
            <button id="new-conversation"
                class="mt-2 w-full px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>New Chat
            </button>
        </div>

        <div class="conversation-list" id="conversation-list">
            <!-- Conversation history will be loaded here -->
        </div>

        <div class="sidebar-footer p-4 border-t">
            <button id="clear-all-conversations"
                class="w-full px-3 py-2 text-red-600 border border-red-200 rounded-lg hover:bg-red-50 transition-colors">
                <i class="fas fa-trash mr-2"></i>Clear All
            </button>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-main">
        <div class="chat-header">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div
                        class="w-10 h-10 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-white"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900">AI Career Coach</h2>
                        <p class="text-sm text-gray-500">Your personal career development assistant</p>
                    </div>
                </div>

                <div class="flex items-center space-x-2">
                    <button id="conversation-history"
                        class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100"
                        title="Conversation history">
                        <i class="fas fa-history"></i>
                    </button>
                    <button id="export-conversation"
                        class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100"
                        title="Export conversation">
                        <i class="fas fa-download"></i>
                    </button>
                    <button id="clear-conversation"
                        class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100"
                        title="Clear conversation">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="chat-messages" id="messages-container">
            <!-- Messages will be loaded here -->
        </div>

        <div class="chat-input">
            <!-- Quick Actions -->
            <div id="quick-actions" class="mb-4">
                <!-- Quick action buttons will be rendered here -->
            </div>

            <form id="message-form" class="input-container">
                <textarea id="message-input" class="message-input" placeholder="Ask me anything about your career..."
                    rows="1"></textarea>

                <div class="flex flex-col space-y-2">
                    <button id="voice-input-btn" type="button"
                        class="p-2 text-gray-400 hover:text-blue-600 rounded-lg hover:bg-gray-100" title="Voice input">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button type="submit" class="send-button" id="send-button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Welcome Modal -->
<div id="welcome-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg p-6 max-w-md mx-4">
        <div class="text-center mb-4">
            <div
                class="w-16 h-16 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-robot text-white text-2xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-900">Welcome to AI Career Coach!</h3>
            <p class="text-gray-600 mt-2">I'm here to help you with career guidance, resume tips, interview preparation,
                and more.</p>
        </div>

        <div class="space-y-3 mb-6">
            <div class="flex items-center space-x-3 text-sm">
                <i class="fas fa-check text-green-500"></i>
                <span>Personalized career advice</span>
            </div>
            <div class="flex items-center space-x-3 text-sm">
                <i class="fas fa-check text-green-500"></i>
                <span>Resume optimization tips</span>
            </div>
            <div class="flex items-center space-x-3 text-sm">
                <i class="fas fa-check text-green-500"></i>
                <span>Interview preparation help</span>
            </div>
            <div class="flex items-center space-x-3 text-sm">
                <i class="fas fa-check text-green-500"></i>
                <span>Skill development guidance</span>
            </div>
        </div>

        <div class="flex space-x-3">
            <button id="skip-tour"
                class="flex-1 px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                Skip
            </button>
            <button id="start-tour" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Get Started
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script>
    // Chat page specific initialization
    document.addEventListener('DOMContentLoaded', function () {
        // Show welcome modal for first-time users
        const hasVisited = localStorage.getItem('chat_visited');
        if (!hasVisited) {
            document.getElementById('welcome-modal').classList.remove('hidden');
        }

        // Handle welcome modal buttons
        document.getElementById('skip-tour').addEventListener('click', function () {
            document.getElementById('welcome-modal').classList.add('hidden');
            localStorage.setItem('chat_visited', 'true');
        });

        document.getElementById('start-tour').addEventListener('click', function () {
            document.getElementById('welcome-modal').classList.add('hidden');
            localStorage.setItem('chat_visited', 'true');
            startTour();
        });

        // New conversation button
        document.getElementById('new-conversation').addEventListener('click', function () {
            if (window.aiCoachChat) {
                window.aiCoachChat.clearConversation();
            }
        });

        // Clear all conversations
        document.getElementById('clear-all-conversations').addEventListener('click', function () {
            if (confirm('Are you sure you want to clear all conversations? This action cannot be undone.')) {
                clearAllConversations();
            }
        });
    });

    function startTour() {
        // Simple tour highlighting key features
        const tourSteps = [
            {
                element: '#quick-actions',
                title: 'Quick Actions',
                content: 'Use these buttons for common career questions'
            },
            {
                element: '#message-input',
                title: 'Ask Anything',
                content: 'Type your career questions here - I can help with resumes, interviews, skills, and more!'
            },
            {
                element: '#voice-input-btn',
                title: 'Voice Input',
                content: 'You can also speak your questions using voice input'
            }
        ];

        let currentStep = 0;

        function showTourStep(step) {
            if (step >= tourSteps.length) return;

            const stepData = tourSteps[step];
            const element = document.querySelector(stepData.element);

            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Create tour tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'tour-tooltip fixed z-50 bg-gray-900 text-white p-4 rounded-lg max-w-xs';
                tooltip.innerHTML = `
                <h4 class="font-semibold mb-2">${stepData.title}</h4>
                <p class="text-sm mb-3">${stepData.content}</p>
                <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-400">${step + 1} of ${tourSteps.length}</span>
                    <button onclick="nextTourStep()" class="text-blue-400 hover:text-blue-300 text-sm">
                        ${step === tourSteps.length - 1 ? 'Finish' : 'Next'}
                    </button>
                </div>
            `;

                // Position tooltip
                const rect = element.getBoundingClientRect();
                tooltip.style.top = rect.bottom + 10 + 'px';
                tooltip.style.left = Math.min(rect.left, window.innerWidth - 300) + 'px';

                document.body.appendChild(tooltip);

                // Store for cleanup
                window.currentTooltip = tooltip;
            }

            currentStep = step;
        }

        window.nextTourStep = function () {
            if (window.currentTooltip) {
                window.currentTooltip.remove();
            }

            if (currentStep < tourSteps.length - 1) {
                showTourStep(currentStep + 1);
            } else {
                // Tour finished
                if (window.aiCoachChat) {
                    // Trigger a welcome message
                    const welcomeBtn = document.querySelector('[data-action="career-advice"]');
                    if (welcomeBtn) {
                        welcomeBtn.click();
                    }
                }
            }
        };

        showTourStep(0);
    }

    function clearAllConversations() {
        // Clear from localStorage
        const keys = Object.keys(localStorage);
        keys.forEach(key => {
            if (key.startsWith('conversation_')) {
                localStorage.removeItem(key);
            }
        });

        // Clear conversation list
        const conversationList = document.getElementById('conversation-list');
        conversationList.innerHTML = '<div class="p-4 text-center text-gray-500">No conversations yet</div>';

        // Clear current conversation
        if (window.aiCoachChat) {
            window.aiCoachChat.clearConversation();
        }

        showNotification('All conversations cleared', 'info');
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-3 rounded-lg text-white text-sm max-w-sm transform translate-x-full transition-transform duration-300 ${type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                    type === 'warning' ? 'bg-yellow-500' :
                        'bg-blue-500'
            }`;

        notification.innerHTML = `
        <div class="flex items-center justify-between">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white/80 hover:text-white">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
    `;

        document.body.appendChild(notification);

        setTimeout(() => notification.classList.remove('translate-x-full'), 100);
        setTimeout(() => {
            if (notification.parentNode) {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }
        }, 3000);
    }
</script>
{% endblock %}